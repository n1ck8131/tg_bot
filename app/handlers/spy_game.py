"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–≥—Ä—ã "–î–æ—Å—Ç–∞—Ç—å –Ω–æ–∂–∏".

–ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –∏–≥—Ä–∞ –¥–ª—è –≤–µ—á–µ—Ä–∏–Ω–∫–∏ —Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π –∏–≥—Ä–æ–∫–æ–≤,
–∫–æ–ª—å—Ü–µ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π –∑–∞–¥–∞–Ω–∏–π, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º —Å–º–µ—Ä—Ç–µ–π –∏ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º –æ—Ç—á—ë—Ç–æ–º.

–û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ —á–µ—Ä–µ–∑ –ª–∏—á–∫—É –±–æ—Ç–∞
- –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º —Å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏
- –ö–æ–ª—å—Ü–µ–≤–æ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–ª–µ–π (–∫–∞–∂–¥—ã–π —É–±–∏–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤ —Ü–µ–ø–æ—á–∫–µ)
- –î–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–º–µ—Ä—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–ª–µ–π –ø–æ—Å–ª–µ —É–±–∏–π—Å—Ç–≤
- –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç —Å —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏–µ–π –∏ –ø—É—Ç—ë–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
- –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ SQLite —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

–ò–≥—Ä–æ–≤–∞—è –º–µ—Ö–∞–Ω–∏–∫–∞:
- –ö–∞–∂–¥—ã–π –∏–≥—Ä–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç —Ü–µ–ª—å, –æ—Ä—É–∂–∏–µ –∏ –ª–æ–∫–∞—Ü–∏—é
- –ñ–µ—Ä—Ç–≤–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Å–º–µ—Ä—Ç—å –∫–Ω–æ–ø–∫–æ–π "–Ø –º—ë—Ä—Ç–≤"
- –£–±–∏–π—Ü–∞ –ø–æ–ª—É—á–∞–µ—Ç —Ü–µ–ª—å –∂–µ—Ä—Ç–≤—ã —Å –Ω–æ–≤—ã–º –æ—Ä—É–∂–∏–µ–º/–ª–æ–∫–∞—Ü–∏–µ–π
- –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞: "–∫—É—Ä–∏–ª–∫–∞" (—É–±–∏–π—Å—Ç–≤–∞ —Ç–∞–º –∑–∞–ø—Ä–µ—â–µ–Ω—ã)
- –ò–≥—Ä–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –¥–æ –æ–¥–Ω–æ–≥–æ –≤—ã–∂–∏–≤—à–µ–≥–æ
"""

import logging
import random
from datetime import datetime
from zoneinfo import ZoneInfo

from aiogram import Bot, Router, F
from aiogram.filters import CommandStart
from aiogram.types import Message, CallbackQuery
from aiogram.enums import ChatType
from aiogram.fsm.context import FSMContext

from app.config import settings
from app.constants import (
    MIN_ASSASSIN_PARTICIPANTS,
    MAX_ASSASSIN_PARTICIPANTS,
    DEFAULT_TEST_PLAYERS,
    SAFE_ZONE,
    DEFAULT_WEAPONS,
    DEFAULT_LOCATIONS,
)
from app.messages import Messages, ButtonLabels, Emojis
from app.callbacks import AssassinCallbacks
from app.keyboards import (
    get_assassin_admin_menu,
    get_assassin_registration_keyboard,
    get_assassin_player_menu,
    get_assassin_death_confirm_keyboard,
    get_assassin_test_count_keyboard,
    get_assassin_test_menu,
    get_assassin_test_player_list_keyboard,
    get_assassin_test_player_actions_keyboard,
    get_assassin_test_death_confirm_keyboard,
)
from app.states import AssassinState
from app.database import (
    get_active_game,
    create_game,
    get_game_by_id,
    update_game_status,
    create_player,
    get_player_by_tg_id,
    get_player_by_id,
    get_all_players,
    get_alive_players,
    mark_player_dead,
    count_players,
    create_contract,
    get_active_contract_for_assassin,
    get_active_contract_for_target,
    deactivate_contract,
    create_kill_log,
    get_all_kills,
    get_kills_by_killer,
    add_weapon,
    get_active_weapons,
    clear_weapons,
    add_location,
    get_active_locations,
    clear_locations,
)

logger = logging.getLogger(__name__)

assassin_router = Router()

ADMIN_ID = settings.bot.admin_id
GROUP_ID = settings.bot.group_id
TIMEZONE = ZoneInfo(settings.bot.timezone)


# === –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ ===


def get_mention_html(user_id: int, username: str | None, display_name: str) -> str:
    """–°–æ–∑–¥–∞—ë—Ç HTML-—É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    if username:
        return f'<a href="https://t.me/{username}">{display_name}</a>'
    return f'<a href="tg://user?id={user_id}">{display_name}</a>'


def distribute_targets(players: list) -> list[tuple[int, int]]:
    """
    –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ü–µ–ª–∏ –ø–æ –∫–æ–ª—å—Ü—É.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø–∞—Ä (—É–±–∏–π—Ü–∞_id, –∂–µ—Ä—Ç–≤–∞_id).
    """
    player_ids = [p["id"] for p in players]
    random.shuffle(player_ids)

    assignments = []
    for i in range(len(player_ids)):
        assassin = player_ids[i]
        target = player_ids[(i + 1) % len(player_ids)]
        assignments.append((assassin, target))

    return assignments


async def assign_contracts(game_id: int, assignments: list[tuple[int, int]]) -> None:
    """–°–æ–∑–¥–∞—ë—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –¥–ª—è –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤."""
    weapons = get_active_weapons()
    locations = get_active_locations()

    if not weapons:
        weapons = DEFAULT_WEAPONS
    if not locations:
        locations = DEFAULT_LOCATIONS

    for assassin_id, target_id in assignments:
        weapon = random.choice(weapons)
        location = random.choice(locations)
        create_contract(game_id, assassin_id, target_id, weapon, location)


async def send_contract_to_player(bot: Bot, game_id: int, player_id: int, tg_user_id: int | None) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏–≥—Ä–æ–∫—É –≤ –ª–∏—á–∫—É."""
    if not tg_user_id:
        return  # –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∏–≥—Ä–æ–∫

    contract = get_active_contract_for_assassin(game_id, player_id)
    if not contract:
        return

    target = get_player_by_id(contract["target_player_id"])
    if not target:
        return

    message_text = Messages.ASSASSIN_YOUR_CONTRACT.format(
        target=target["mention_html"],
        weapon=contract["weapon_text"],
        location=contract["location_text"],
    )

    try:
        await bot.send_message(
            tg_user_id,
            message_text,
            parse_mode="HTML",
            reply_markup=get_assassin_player_menu(),
        )
    except Exception as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏–≥—Ä–æ–∫—É {tg_user_id}: {e}")


async def process_death(
    bot: Bot, game_id: int, victim_id: int, is_test: bool
) -> dict:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–º–µ—Ä—Ç—å –∏–≥—Ä–æ–∫–∞.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ.
    """
    game = get_game_by_id(game_id)
    if not game or game["status"] != "running":
        return {"success": False, "error": "–ò–≥—Ä–∞ –Ω–µ –∏–¥—ë—Ç"}

    victim = get_player_by_id(victim_id)
    if not victim or not victim["is_alive"]:
        return {"success": False, "error": "–ò–≥—Ä–æ–∫ —É–∂–µ –º—ë—Ä—Ç–≤"}

    # –ù–∞–π—Ç–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ –∂–µ—Ä—Ç–≤—É
    killer_contract = get_active_contract_for_target(game_id, victim_id)
    if not killer_contract:
        return {"success": False, "error": "–ù–µ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ —ç—Ç—É –∂–µ—Ä—Ç–≤—É"}

    killer = get_player_by_id(killer_contract["assassin_player_id"])
    if not killer:
        return {"success": False, "error": "–ù–µ –Ω–∞–π–¥–µ–Ω —É–±–∏–π—Ü–∞"}

    # –ù–∞–π—Ç–∏ –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∂–µ—Ä—Ç–≤—ã
    victim_contract = get_active_contract_for_assassin(game_id, victim_id)
    if not victim_contract:
        return {"success": False, "error": "–ù–µ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∂–µ—Ä—Ç–≤—ã"}

    # –ó–∞–ø–∏—Å–∞—Ç—å —É–±–∏–π—Å—Ç–≤–æ
    create_kill_log(
        game_id,
        killer["id"],
        victim["id"],
        killer_contract["weapon_text"],
        killer_contract["location_text"],
        is_test,
    )

    # –ü–æ–º–µ—Ç–∏—Ç—å –∂–µ—Ä—Ç–≤—É –º—ë—Ä—Ç–≤–æ–π
    mark_player_dead(victim_id)

    # –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
    deactivate_contract(killer_contract["id"])
    deactivate_contract(victim_contract["id"])

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∂–∏–≤—ã—Ö
    alive_players = get_alive_players(game_id)

    if len(alive_players) == 1:
        # –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞
        winner = alive_players[0]
        update_game_status(
            game_id,
            "finished",
            finished_at=datetime.now(),
            winner_player_id=winner["id"],
        )

        # –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç
        await send_final_report(bot, game_id, is_test)

        return {
            "success": True,
            "game_finished": True,
            "winner": winner,
            "killer": killer,
            "victim": victim,
        }

    # –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –¥–ª—è —É–±–∏–π—Ü—ã
    new_target_id = victim_contract["target_player_id"]

    weapons = get_active_weapons() or DEFAULT_WEAPONS
    locations = get_active_locations() or DEFAULT_LOCATIONS

    new_weapon = random.choice(weapons)
    new_location = random.choice(locations)

    create_contract(game_id, killer["id"], new_target_id, new_weapon, new_location)

    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ —É–±–∏–π—Ü–µ
    await send_new_contract_to_killer(bot, game_id, killer, new_target_id, new_weapon, new_location)

    return {
        "success": True,
        "game_finished": False,
        "killer": killer,
        "victim": victim,
        "new_target_id": new_target_id,
    }


async def send_new_contract_to_killer(
    bot: Bot, game_id: int, killer: dict, target_id: int, weapon: str, location: str
) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç —É–±–∏–π—Ü–µ."""
    if not killer["tg_user_id"]:
        return  # –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∏–≥—Ä–æ–∫

    target = get_player_by_id(target_id)
    if not target:
        return

    message_text = Messages.ASSASSIN_NEW_CONTRACT.format(
        target=target["mention_html"],
        weapon=weapon,
        location=location,
    )

    try:
        await bot.send_message(
            killer["tg_user_id"],
            message_text,
            parse_mode="HTML",
            reply_markup=get_assassin_player_menu(),
        )
    except Exception as e:
        logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏–≥—Ä–æ–∫—É {killer['tg_user_id']}: {e}")


async def send_death_announcement(bot: Bot, game_id: int, victim: dict, is_test: bool) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∞–Ω–æ–Ω—Å —Å–º–µ—Ä—Ç–∏."""
    announcement = Messages.ASSASSIN_DEATH_ANNOUNCEMENT.format(
        victim=victim["display_name"]
    )

    if is_test:
        announcement = Messages.ASSASSIN_TEST_DEATH_ANNOUNCEMENT.format(
            victim=victim["display_name"]
        )
        try:
            await bot.send_message(ADMIN_ID, announcement, parse_mode="HTML")
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –∞–Ω–æ–Ω—Å –∞–¥–º–∏–Ω—É: {e}")
    else:
        try:
            await bot.send_message(GROUP_ID, announcement, parse_mode="HTML")
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω—Å –≤ –≥—Ä—É–ø–ø—É: {e}")


async def send_final_report(bot: Bot, game_id: int, is_test: bool) -> None:
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç."""
    game = get_game_by_id(game_id)
    if not game:
        return

    winner = get_player_by_id(game["winner_player_id"])
    if not winner:
        return

    all_kills = get_all_kills(game_id)
    winner_kills = get_kills_by_killer(game_id, winner["id"])

    # –•—Ä–æ–Ω–æ–ª–æ–≥–∏—è
    chronology_lines = []
    for kill in all_kills:
        # kill["killed_at"] —É–∂–µ datetime –æ–±—ä–µ–∫—Ç –∏–∑ SQLite
        killed_time = kill["killed_at"]
        if isinstance(killed_time, str):
            killed_time = datetime.fromisoformat(killed_time)
        killed_time = killed_time.astimezone(TIMEZONE)

        chronology_lines.append(
            Messages.ASSASSIN_KILL_ENTRY.format(
                time=killed_time.strftime("%H:%M"),
                killer=kill["killer_mention"],
                victim=kill["victim_mention"],
                location=kill["location_text"],
                weapon=kill["weapon_text"],
            )
        )

    chronology = Messages.ASSASSIN_CHRONOLOGY.format(kills="".join(chronology_lines))

    # –ü—É—Ç—å –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    winner_path_lines = []
    for kill in winner_kills:
        # kill["killed_at"] —É–∂–µ datetime –æ–±—ä–µ–∫—Ç –∏–∑ SQLite
        killed_time = kill["killed_at"]
        if isinstance(killed_time, str):
            killed_time = datetime.fromisoformat(killed_time)
        killed_time = killed_time.astimezone(TIMEZONE)

        winner_path_lines.append(
            Messages.ASSASSIN_KILL_ENTRY.format(
                time=killed_time.strftime("%H:%M"),
                killer=winner["mention_html"],
                victim=kill["victim_mention"],
                location=kill["location_text"],
                weapon=kill["weapon_text"],
            )
        )

    winner_path = ""
    if winner_path_lines:
        winner_path = Messages.ASSASSIN_WINNER_PATH.format(kills="".join(winner_path_lines))

    report = chronology + winner_path + "üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º –ø–æ–±–µ–¥–∏—Ç–µ–ª—è!"

    final_message = Messages.ASSASSIN_GAME_FINISHED.format(
        winner=winner["mention_html"],
        report=report,
    )

    if is_test:
        final_message = f"üß™ TEST RESULT:\n\n{final_message}"
        try:
            await bot.send_message(ADMIN_ID, final_message, parse_mode="HTML")
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –∞–¥–º–∏–Ω—É: {e}")
    else:
        try:
            await bot.send_message(GROUP_ID, final_message, parse_mode="HTML")
        except Exception as e:
            logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –≤ –≥—Ä—É–ø–ø—É: {e}")


# === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∞–¥–º–∏–Ω–∞ ===


@assassin_router.message(
    F.text.in_([f"{Emojis.SPY} –®–ø–∏–æ–Ω", "üî™ –î–æ—Å—Ç–∞—Ç—å –Ω–æ–∂–∏"]),
    F.chat.type == ChatType.PRIVATE,
    F.from_user.id == ADMIN_ID,
)
async def admin_assassin_menu(message: Message) -> None:
    """–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é –∏–≥—Ä—ã."""
    await message.answer(
        Messages.ASSASSIN_MENU_TITLE,
        parse_mode="Markdown",
        reply_markup=get_assassin_admin_menu(),
    )


@assassin_router.callback_query(
    F.data == AssassinCallbacks.ADMIN_MENU,
    F.from_user.id == ADMIN_ID,
)
async def admin_assassin_menu_callback(callback: CallbackQuery) -> None:
    """–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é –∏–≥—Ä—ã."""
    await callback.message.edit_text(
        Messages.ASSASSIN_MENU_TITLE,
        parse_mode="Markdown",
        reply_markup=get_assassin_admin_menu(),
    )
    await callback.answer()


@assassin_router.callback_query(
    F.data == AssassinCallbacks.OPEN_REGISTRATION,
    F.from_user.id == ADMIN_ID,
)
async def admin_open_registration(callback: CallbackQuery, bot: Bot) -> None:
    """–û—Ç–∫—Ä—ã—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –Ω–∞ –∏–≥—Ä—É."""
    game = get_active_game()

    if game and game["status"] == "registration":
        await callback.answer(Messages.ASSASSIN_REG_ALREADY_OPEN, show_alert=True)
        return

    if game and game["status"] == "running":
        await callback.answer(Messages.ASSASSIN_GAME_ALREADY_RUNNING, show_alert=True)
        return

    # –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É
    game_id = create_game(is_test_mode=False, group_chat_id=GROUP_ID)

    # –û–±—ä—è–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É - —Å–Ω–∞—á–∞–ª–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    await bot.send_message(
        GROUP_ID,
        Messages.ASSASSIN_REGISTRATION_OPEN,
        parse_mode="Markdown",
    )

    # –ó–∞—Ç–µ–º —É—Å—Ç—Ä–∞—à–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await bot.send_message(
        GROUP_ID,
        Messages.ASSASSIN_GAME_STARTING,
        parse_mode="Markdown",
    )

    await callback.message.edit_text(
        f"{Emojis.SUCCESS} {Messages.ASSASSIN_REG_OPENED}",
        reply_markup=get_assassin_admin_menu(),
    )
    await callback.answer()


@assassin_router.callback_query(
    F.data == AssassinCallbacks.SET_WEAPONS,
    F.from_user.id == ADMIN_ID,
)
async def admin_set_weapons(callback: CallbackQuery, state: FSMContext) -> None:
    """–ó–∞–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ –æ—Ä—É–∂–∏–π."""
    await state.set_state(AssassinState.waiting_for_weapons)
    await callback.message.edit_text(
        Messages.ASSASSIN_WEAPONS_PROMPT,
        parse_mode="Markdown",
    )
    await callback.answer()


@assassin_router.message(
    AssassinState.waiting_for_weapons,
    F.chat.type == ChatType.PRIVATE,
    F.from_user.id == ADMIN_ID,
)
async def process_weapons_list(message: Message, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ø–∏—Å–æ–∫ –æ—Ä—É–∂–∏–π."""
    await state.clear()

    weapons = [line.strip() for line in message.text.split("\n") if line.strip()]

    clear_weapons()
    count = 0
    for weapon in weapons:
        add_weapon(weapon)
        count += 1

    await message.answer(
        f"{Emojis.SUCCESS} {Messages.ASSASSIN_WEAPONS_SAVED.format(count=count)}",
        reply_markup=get_assassin_admin_menu(),
    )


@assassin_router.callback_query(
    F.data == AssassinCallbacks.SET_LOCATIONS,
    F.from_user.id == ADMIN_ID,
)
async def admin_set_locations(callback: CallbackQuery, state: FSMContext) -> None:
    """–ó–∞–¥–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ª–æ–∫–∞—Ü–∏–π."""
    await state.set_state(AssassinState.waiting_for_locations)
    await callback.message.edit_text(
        Messages.ASSASSIN_LOCATIONS_PROMPT,
        parse_mode="Markdown",
    )
    await callback.answer()


@assassin_router.message(
    AssassinState.waiting_for_locations,
    F.chat.type == ChatType.PRIVATE,
    F.from_user.id == ADMIN_ID,
)
async def process_locations_list(message: Message, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ª–æ–∫–∞—Ü–∏–π."""
    await state.clear()

    locations = [line.strip() for line in message.text.split("\n") if line.strip()]

    clear_locations()
    count = 0
    skipped = []

    for location in locations:
        if location.lower() == SAFE_ZONE.lower():
            skipped.append(location)
            continue
        add_location(location)
        count += 1

    response = f"{Emojis.SUCCESS} {Messages.ASSASSIN_LOCATIONS_SAVED.format(count=count)}"

    if skipped:
        for loc in skipped:
            response += f"\n{Messages.ASSASSIN_LOCATION_SAFE_ZONE_SKIP.format(location=loc)}"

    await message.answer(
        response,
        reply_markup=get_assassin_admin_menu(),
    )


@assassin_router.callback_query(
    F.data == AssassinCallbacks.SHOW_LISTS,
    F.from_user.id == ADMIN_ID,
)
async def admin_show_lists(callback: CallbackQuery) -> None:
    """–ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–µ —Å–ø–∏—Å–∫–∏ –æ—Ä—É–∂–∏–π –∏ –ª–æ–∫–∞—Ü–∏–π."""
    weapons = get_active_weapons() or DEFAULT_WEAPONS
    locations = get_active_locations() or DEFAULT_LOCATIONS

    weapons_text = "\n".join(f"‚Ä¢ {w}" for w in weapons)
    locations_text = "\n".join(f"‚Ä¢ {l}" for l in locations)

    response = Messages.ASSASSIN_LISTS_TITLE
    response += Messages.ASSASSIN_WEAPONS_LIST.format(count=len(weapons), list=weapons_text)
    response += Messages.ASSASSIN_LOCATIONS_LIST.format(count=len(locations), list=locations_text)

    await callback.message.edit_text(
        response,
        parse_mode="Markdown",
        reply_markup=get_assassin_admin_menu(),
    )
    await callback.answer()


@assassin_router.callback_query(
    F.data == AssassinCallbacks.START_GAME,
    F.from_user.id == ADMIN_ID,
)
async def admin_start_game(callback: CallbackQuery, bot: Bot) -> None:
    """–ù–∞—á–∞—Ç—å –∏–≥—Ä—É."""
    game = get_active_game()

    if not game:
        await callback.answer(Messages.ASSASSIN_NO_ACTIVE_GAME, show_alert=True)
        return

    if game["status"] != "registration":
        await callback.answer(Messages.ASSASSIN_GAME_ALREADY_RUNNING, show_alert=True)
        return

    players_count = count_players(game["id"])

    if players_count < MIN_ASSASSIN_PARTICIPANTS:
        await callback.answer(Messages.ASSASSIN_MIN_PLAYERS, show_alert=True)
        return

    weapons = get_active_weapons()
    if not weapons:
        weapons = DEFAULT_WEAPONS

    locations = get_active_locations()
    if not locations:
        locations = DEFAULT_LOCATIONS

    if not weapons:
        await callback.answer(Messages.ASSASSIN_NO_WEAPONS, show_alert=True)
        return

    if not locations:
        await callback.answer(Messages.ASSASSIN_NO_LOCATIONS, show_alert=True)
        return

    # –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –∏–≥—Ä–æ–∫–æ–≤
    players = get_all_players(game["id"])
    players_data = [dict(p) for p in players]

    # –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ü–µ–ª–∏
    assignments = distribute_targets(players_data)

    # –°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
    await assign_contracts(game["id"], assignments)

    # –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∏–≥—Ä—ã
    update_game_status(game["id"], "running", started_at=datetime.now())

    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –∏–≥—Ä–æ–∫–∞–º
    for player in players:
        await send_contract_to_player(bot, game["id"], player["id"], player["tg_user_id"])

    # –û–±—ä—è–≤–∏—Ç—å –≤ –≥—Ä—É–ø–ø—É –∏–ª–∏ –∞–¥–º–∏–Ω—É (–µ—Å–ª–∏ —Ç–µ—Å—Ç)
    if game["is_test_mode"]:
        # –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç—Ä–∞—à–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await bot.send_message(
            ADMIN_ID,
            f"üß™ TEST:\n\n{Messages.ASSASSIN_GAME_STARTING}",
            parse_mode="Markdown",
        )
        # –ó–∞—Ç–µ–º —Å—Ç–∞—Ä—Ç
        await bot.send_message(
            ADMIN_ID,
            f"üß™ TEST:\n\n{Messages.ASSASSIN_GAME_STARTED}",
            parse_mode="Markdown",
        )
    else:
        # –°–Ω–∞—á–∞–ª–∞ —É—Å—Ç—Ä–∞—à–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        await bot.send_message(
            GROUP_ID,
            Messages.ASSASSIN_GAME_STARTING,
            parse_mode="Markdown",
        )
        # –ó–∞—Ç–µ–º —Å—Ç–∞—Ä—Ç
        await bot.send_message(
            GROUP_ID,
            Messages.ASSASSIN_GAME_STARTED,
            parse_mode="Markdown",
        )

    if game["is_test_mode"]:
        await callback.message.edit_text(
            f"{Emojis.SUCCESS} {Messages.ASSASSIN_STARTED}\n\n"
            f"*–£–ø—Ä–∞–≤–ª—è–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º–∏ –∏–≥—Ä–æ–∫–∞–º–∏:*\n"
            f"–ù–∞–∂–º–∏ *¬´üë• –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –∏–≥—Ä–æ–∫–∏¬ª* –Ω–∏–∂–µ",
            parse_mode="Markdown",
            reply_markup=get_assassin_test_menu(),
        )
    else:
        await callback.message.edit_text(
            f"{Emojis.SUCCESS} {Messages.ASSASSIN_STARTED}",
            reply_markup=get_assassin_admin_menu(),
        )
    await callback.answer()


@assassin_router.callback_query(
    F.data == AssassinCallbacks.RESET_GAME,
    F.from_user.id == ADMIN_ID,
)
async def admin_reset_game(callback: CallbackQuery) -> None:
    """–°–±—Ä–æ—Å–∏—Ç—å –∏–≥—Ä—É."""
    game = get_active_game()

    if not game:
        await callback.answer("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä—ã", show_alert=True)
        return

    # –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É
    update_game_status(game["id"], "finished", finished_at=datetime.now())

    await callback.message.edit_text(
        f"{Emojis.SUCCESS} {Messages.ASSASSIN_RESET_DONE}",
        reply_markup=get_assassin_admin_menu(),
    )
    await callback.answer()


# === –¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º ===


@assassin_router.callback_query(
    F.data == AssassinCallbacks.TEST_MODE,
    F.from_user.id == ADMIN_ID,
)
async def admin_test_mode(callback: CallbackQuery, state: FSMContext) -> None:
    """–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º."""
    game = get_active_game()
    if game:
        await callback.answer(Messages.ASSASSIN_GAME_ALREADY_RUNNING, show_alert=True)
        return

    await state.set_state(AssassinState.waiting_for_test_count)
    await callback.message.edit_text(
        Messages.ASSASSIN_TEST_MODE_PROMPT,
        parse_mode="Markdown",
        reply_markup=get_assassin_test_count_keyboard(),
    )
    await callback.answer()


@assassin_router.callback_query(
    F.data.startswith(f"{AssassinCallbacks.TEST_MODE}:"),
    F.from_user.id == ADMIN_ID,
)
async def admin_test_mode_default(callback: CallbackQuery, state: FSMContext) -> None:
    """–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∏–≥—Ä—É —Å –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º."""
    count = int(callback.data.split(":")[-1])
    await create_test_game(callback.message, state, count)
    await callback.answer()


@assassin_router.message(
    AssassinState.waiting_for_test_count,
    F.chat.type == ChatType.PRIVATE,
    F.from_user.id == ADMIN_ID,
)
async def process_test_count(message: Message, state: FSMContext) -> None:
    """–û–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤."""
    try:
        count = int(message.text.strip())
        if count < MIN_ASSASSIN_PARTICIPANTS or count > MAX_ASSASSIN_PARTICIPANTS:
            await message.answer(Messages.ASSASSIN_TEST_INVALID_COUNT)
            return

        await create_test_game(message, state, count)
    except ValueError:
        await message.answer(Messages.ASSASSIN_TEST_INVALID_COUNT)


async def create_test_game(message: Message, state: FSMContext, count: int) -> None:
    """–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—É—é –∏–≥—Ä—É."""
    await state.clear()

    # –°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É
    game_id = create_game(is_test_mode=True, group_chat_id=GROUP_ID)

    # –°–æ–∑–¥–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤
    for i in range(1, count + 1):
        name = f"Virtual #{i:02d}"
        create_player(
            game_id=game_id,
            display_name=name,
            mention_html=name,
            is_virtual=True,
        )

    await message.answer(
        f"{Emojis.SUCCESS} {Messages.ASSASSIN_TEST_CREATED.format(count=count)}",
        reply_markup=get_assassin_test_menu(),
    )


@assassin_router.callback_query(
    F.data == AssassinCallbacks.TEST_PLAYERS_LIST,
    F.from_user.id == ADMIN_ID,
)
async def admin_test_players_list(callback: CallbackQuery) -> None:
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤."""
    game = get_active_game()
    if not game:
        await callback.answer("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∏–≥—Ä—ã", show_alert=True)
        return

    players = get_all_players(game["id"])
    players_data = [dict(p) for p in players]

    await callback.message.edit_text(
        Messages.ASSASSIN_TEST_PLAYERS_LIST_TITLE,
        parse_mode="Markdown",
        reply_markup=get_assassin_test_player_list_keyboard(players_data),
    )
    await callback.answer()


@assassin_router.callback_query(
    F.data.startswith(f"{AssassinCallbacks.TEST_SELECT_PLAYER}:"),
    F.from_user.id == ADMIN_ID,
)
async def admin_test_select_player(callback: CallbackQuery) -> None:
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–º –∏–≥—Ä–æ–∫–µ."""
    player_id = int(callback.data.split(":")[-1])
    player = get_player_by_id(player_id)

    if not player:
        await callback.answer("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return

    game = get_game_by_id(player["game_id"])
    if not game:
        await callback.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    status = Messages.ASSASSIN_TEST_PLAYER_ALIVE if player["is_alive"] else Messages.ASSASSIN_TEST_PLAYER_DEAD

    contract_text = ""
    if player["is_alive"] and game["status"] == "running":
        contract = get_active_contract_for_assassin(game["id"], player["id"])
        if contract:
            target = get_player_by_id(contract["target_player_id"])
            if target:
                contract_text = Messages.ASSASSIN_YOUR_CONTRACT.format(
                    target=target["display_name"],
                    weapon=contract["weapon_text"],
                    location=contract["location_text"],
                )

    message_text = Messages.ASSASSIN_TEST_PLAYER_INFO.format(
        name=player["display_name"],
        status=status,
        contract=contract_text,
    )

    await callback.message.edit_text(
        message_text,
        parse_mode="HTML",
        reply_markup=get_assassin_test_player_actions_keyboard(player["id"], player["is_alive"]),
    )
    await callback.answer()


@assassin_router.callback_query(
    F.data.startswith(f"{AssassinCallbacks.TEST_KILL_PLAYER}:"),
    F.from_user.id == ADMIN_ID,
)
async def admin_test_kill_player(callback: CallbackQuery) -> None:
    """–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–º–µ—Ä—Ç–∏ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞."""
    player_id = int(callback.data.split(":")[-1])
    player = get_player_by_id(player_id)

    if not player:
        await callback.answer("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return

    game = get_game_by_id(player["game_id"])
    if not game:
        await callback.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    # –ù–∞–π—Ç–∏ —É–±–∏–π—Ü—É
    killer_contract = get_active_contract_for_target(game["id"], player["id"])
    if not killer_contract:
        await callback.answer("–ù–µ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞", show_alert=True)
        return

    killer = get_player_by_id(killer_contract["assassin_player_id"])
    if not killer:
        await callback.answer("–ù–µ –Ω–∞–π–¥–µ–Ω —É–±–∏–π—Ü–∞", show_alert=True)
        return

    message_text = Messages.ASSASSIN_DEATH_CONFIRM_PROMPT.format(
        killer=killer["display_name"]
    )

    await callback.message.edit_text(
        message_text,
        parse_mode="HTML",
        reply_markup=get_assassin_test_death_confirm_keyboard(player["id"]),
    )
    await callback.answer()


@assassin_router.callback_query(
    F.data.startswith(f"{AssassinCallbacks.TEST_CONFIRM_KILL}:"),
    F.from_user.id == ADMIN_ID,
)
async def admin_test_confirm_kill(callback: CallbackQuery, bot: Bot) -> None:
    """–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å —Å–º–µ—Ä—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞."""
    player_id = int(callback.data.split(":")[-1])
    player = get_player_by_id(player_id)

    if not player:
        await callback.answer("–ò–≥—Ä–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω", show_alert=True)
        return

    game = get_game_by_id(player["game_id"])
    if not game:
        await callback.answer("–ò–≥—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–º–µ—Ä—Ç—å
    result = await process_death(bot, game["id"], player["id"], is_test=True)

    if not result["success"]:
        await callback.answer(result.get("error", "–û—à–∏–±–∫–∞"), show_alert=True)
        return

    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω—Å
    await send_death_announcement(bot, game["id"], player, is_test=True)

    if result["game_finished"]:
        await callback.message.edit_text(
            "üèÜ –ò–≥—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.",
            reply_markup=get_assassin_admin_menu(),
        )
    else:
        await callback.message.edit_text(
            f"‚ò†Ô∏è {player['display_name']} –º—ë—Ä—Ç–≤!",
            reply_markup=get_assassin_test_menu(),
        )

    await callback.answer()


# === –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏–≥—Ä–æ–∫–æ–≤ ===


@assassin_router.message(
    CommandStart(),
    F.chat.type == ChatType.PRIVATE,
    ~(F.from_user.id == ADMIN_ID),
)
async def cmd_start_player(message: Message) -> None:
    """–ö–æ–º–∞–Ω–¥–∞ /start –¥–ª—è –∏–≥—Ä–æ–∫–∞."""
    game = get_active_game()

    if not game:
        await message.answer(Messages.ASSASSIN_NO_ACTIVE_GAME)
        return

    if game["status"] == "registration":
        await message.answer(
            Messages.ASSASSIN_NO_ACTIVE_GAME + "\n\n–ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫—É –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:",
            reply_markup=get_assassin_registration_keyboard(),
        )
        return

    if game["status"] == "running":
        player = get_player_by_tg_id(game["id"], message.from_user.id)
        if not player:
            await message.answer(Messages.ASSASSIN_NOT_IN_GAME)
            return

        if not player["is_alive"]:
            await message.answer(Messages.ASSASSIN_ALREADY_DEAD)
            return

        await message.answer(
            "–ò–≥—Ä–∞ –∏–¥—ë—Ç! –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏:",
            reply_markup=get_assassin_player_menu(),
        )
        return


@assassin_router.callback_query(
    F.data == AssassinCallbacks.REGISTER,
)
async def player_register(callback: CallbackQuery) -> None:
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–≥—Ä–æ–∫–∞."""
    game = get_active_game()

    if not game:
        await callback.answer(Messages.ASSASSIN_NO_ACTIVE_GAME, show_alert=True)
        return

    if game["status"] != "registration":
        await callback.answer(Messages.ASSASSIN_REG_CLOSED, show_alert=True)
        return

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ —É–∂–µ
    existing = get_player_by_tg_id(game["id"], callback.from_user.id)
    if existing:
        await callback.answer(Messages.ASSASSIN_ALREADY_REGISTERED, show_alert=True)
        return

    # –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å
    display_name = callback.from_user.full_name
    username = callback.from_user.username
    mention_html = get_mention_html(callback.from_user.id, username, display_name)

    create_player(
        game_id=game["id"],
        display_name=display_name,
        mention_html=mention_html,
        tg_user_id=callback.from_user.id,
        username=username,
        is_virtual=False,
    )

    await callback.message.edit_text(
        Messages.ASSASSIN_REGISTERED.format(mention=mention_html),
        parse_mode="HTML",
    )
    await callback.answer()


@assassin_router.callback_query(
    F.data == AssassinCallbacks.SHOW_CONTRACT,
)
async def player_show_contract(callback: CallbackQuery) -> None:
    """–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏–≥—Ä–æ–∫—É."""
    game = get_active_game()

    if not game or game["status"] != "running":
        await callback.answer(Messages.ASSASSIN_NO_ACTIVE_GAME, show_alert=True)
        return

    player = get_player_by_tg_id(game["id"], callback.from_user.id)
    if not player:
        await callback.answer(Messages.ASSASSIN_NOT_IN_GAME, show_alert=True)
        return

    if not player["is_alive"]:
        await callback.answer(Messages.ASSASSIN_ALREADY_DEAD, show_alert=True)
        return

    contract = get_active_contract_for_assassin(game["id"], player["id"])
    if not contract:
        await callback.answer("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞", show_alert=True)
        return

    target = get_player_by_id(contract["target_player_id"])
    if not target:
        await callback.answer("–¶–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞", show_alert=True)
        return

    message_text = Messages.ASSASSIN_YOUR_CONTRACT.format(
        target=target["mention_html"],
        weapon=contract["weapon_text"],
        location=contract["location_text"],
    )

    await callback.message.edit_text(
        message_text,
        parse_mode="HTML",
        reply_markup=get_assassin_player_menu(),
    )
    await callback.answer()


@assassin_router.callback_query(
    F.data == AssassinCallbacks.I_AM_DEAD,
)
async def player_i_am_dead(callback: CallbackQuery) -> None:
    """–ò–≥—Ä–æ–∫ –Ω–∞–∂–∞–ª '–Ø –º—ë—Ä—Ç–≤'."""
    game = get_active_game()

    if not game or game["status"] != "running":
        await callback.answer(Messages.ASSASSIN_NO_ACTIVE_GAME, show_alert=True)
        return

    player = get_player_by_tg_id(game["id"], callback.from_user.id)
    if not player:
        await callback.answer(Messages.ASSASSIN_NOT_IN_GAME, show_alert=True)
        return

    if not player["is_alive"]:
        await callback.answer(Messages.ASSASSIN_ALREADY_DEAD, show_alert=True)
        return

    # –ù–∞–π—Ç–∏ —É–±–∏–π—Ü—É
    killer_contract = get_active_contract_for_target(game["id"], player["id"])
    if not killer_contract:
        await callback.answer("–ù–µ –Ω–∞–π–¥–µ–Ω –∫–æ–Ω—Ç—Ä–∞–∫—Ç –Ω–∞ —Ç–µ–±—è", show_alert=True)
        return

    killer = get_player_by_id(killer_contract["assassin_player_id"])
    if not killer:
        await callback.answer("–ù–µ –Ω–∞–π–¥–µ–Ω —É–±–∏–π—Ü–∞", show_alert=True)
        return

    # –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    message_text = Messages.ASSASSIN_DEATH_CONFIRM_PROMPT.format(
        killer=killer["mention_html"]
    )

    await callback.message.edit_text(
        message_text,
        parse_mode="HTML",
        reply_markup=get_assassin_death_confirm_keyboard(),
    )
    await callback.answer()


@assassin_router.callback_query(
    F.data == AssassinCallbacks.CONFIRM_DEATH,
)
async def player_confirm_death(callback: CallbackQuery, bot: Bot) -> None:
    """–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–º–µ—Ä—Ç–∏ –∏–≥—Ä–æ–∫–æ–º."""
    game = get_active_game()

    if not game or game["status"] != "running":
        await callback.answer(Messages.ASSASSIN_NO_ACTIVE_GAME, show_alert=True)
        return

    player = get_player_by_tg_id(game["id"], callback.from_user.id)
    if not player:
        await callback.answer(Messages.ASSASSIN_NOT_IN_GAME, show_alert=True)
        return

    # –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–º–µ—Ä—Ç—å
    result = await process_death(bot, game["id"], player["id"], is_test=False)

    if not result["success"]:
        await callback.answer(result.get("error", "–û—à–∏–±–∫–∞"), show_alert=True)
        return

    # –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∞–Ω–æ–Ω—Å
    await send_death_announcement(bot, game["id"], player, is_test=False)

    await callback.message.edit_text(
        Messages.ASSASSIN_DEATH_CONFIRMED,
        parse_mode="HTML",
    )
    await callback.answer()


@assassin_router.callback_query(
    F.data == AssassinCallbacks.CANCEL_DEATH,
)
async def player_cancel_death(callback: CallbackQuery) -> None:
    """–û—Ç–º–µ–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–º–µ—Ä—Ç–∏."""
    await callback.message.edit_text(
        "–û—Ç–º–µ–Ω–µ–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏:",
        reply_markup=get_assassin_player_menu(),
    )
    await callback.answer()
